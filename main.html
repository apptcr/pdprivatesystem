<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRODUCTION TOOLS</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #34495e;
            --accent: #3498db;
            --white: #ffffff;
            --shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Prompt', sans-serif; }
        body { background: #f1f5f9; height: 100vh; overflow: hidden; width: 100vw; }
        .view-container { width: 100%; height: 100vh; position: relative; overflow: hidden; }
        .view-content {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: none; overflow: hidden !important;
        }
        .view-content.active { display: block; }
        iframe { width: 100%; height: 100%; border: none; display: block; overflow: hidden !important; }

        #name-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(44, 62, 80, 0.95);
            display: flex; align-items: center; justify-content: center;
            z-index: 10000; visibility: hidden; opacity: 0; transition: 0.3s;
        }
        #name-overlay.show { visibility: visible; opacity: 1; }
        .name-card {
            background: white; padding: 30px; border-radius: 15px;
            width: 90%; max-width: 350px; text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        .name-card h2 { color: var(--primary); margin-bottom: 10px; font-size: 1.2rem; }
        .name-card p { color: #666; font-size: 0.9rem; margin-bottom: 20px; line-height: 1.5; }
        .name-card input {
            width: 100%; padding: 12px; border: 2px solid #ddd;
            border-radius: 8px; font-size: 1rem; margin-bottom: 10px;
            outline: none; text-align: center; transition: 0.2s;
        }
        .name-card input:focus { border-color: var(--accent); }
        .name-card button {
            width: 100%; padding: 12px; background: var(--accent);
            color: white; border: none; border-radius: 8px;
            font-size: 1rem; font-weight: 500; cursor: pointer; transition: 0.2s;
        }
        .name-card button:hover { background: #2980b9; }
        .error-msg { color: #e74c3c; font-size: 0.8rem; margin-bottom: 10px; display: none; }

        /* --- FAB Styles --- */
        .fab-wrapper {
            position: fixed; bottom: 20px; right: 20px;
            display: flex; flex-direction: column-reverse; align-items: center; gap: 10px; z-index: 9999;
        }
        .fab-main {
            width: 45px; height: 45px; border-radius: 50%; background: var(--primary);
            color: white; display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; cursor: pointer; box-shadow: var(--shadow);
            transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); border: 2px solid var(--white);
        }
        .fab-main.open { transform: rotate(135deg); background: #e74c3c; }
        .fab-options {
            display: flex; flex-direction: column; gap: 10px;
            opacity: 0; visibility: hidden; transform: translateY(15px); transition: 0.2s;
        }
        .fab-options.show { opacity: 1; visibility: visible; transform: translateY(0); }
        .fab-btn {
            width: 40px; height: 40px; border-radius: 50%; border: none;
            background: var(--white); color: var(--primary); cursor: pointer;
            box-shadow: var(--shadow); display: flex; align-items: center; justify-content: center;
            font-size: 1rem; transition: 0.2s; position: relative;
        }
        .fab-btn:hover { background: var(--accent); color: white; }
    </style>
</head>
<body>

    <div id="name-overlay">
        <div class="name-card">
            <h2>ยินดีต้อนรับ</h2>
            <p>กรุณาพิมพ์ <b>'ชื่อเล่น'</b> ของคุณ <br>เพื่อบันทึกข้อมูลการใช้งานครั้งแรก<br>บนแพลตฟอร์มนี้</p>
            <div id="error-txt" class="error-msg">กรุณากรอกชื่อก่อนเริ่มใช้งาน</div>
            <input type="text" id="user-nickname" placeholder="ระบุชื่อเล่นที่นี่..." autocomplete="off">
            <button onclick="saveInitialName()">ตกลง</button>
        </div>
    </div>

    <div class="view-container">
        <div id="yield-view" class="view-content">
            <iframe id="yield-frame" src="yieldcal.html" scrolling="no"></iframe>
        </div>
        <div id="tri-view" class="view-content">
            <iframe id="tri-frame" src="ruleofthree.html" scrolling="no"></iframe>
        </div>
    </div>

    <div class="fab-wrapper">
        <button class="fab-main" id="fabMain" onclick="toggleFab()">
            <i class="fas fa-th-large"></i>
        </button>
        <div class="fab-options" id="fabOptions">
            <button class="fab-btn" data-label="Rule of Three" onclick="switchTab('tri-view', 'tri')">
                <i class="fas fa-calculator"></i>
            </button>
            <button class="fab-btn" data-label="Yield Calculator" onclick="switchTab('yield-view', 'yield')">
                <i class="fas fa-chart-line"></i>
            </button>
        </div>
    </div>

    <script>
        const fabMain = document.getElementById('fabMain');
        const fabOptions = document.getElementById('fabOptions');

        function toggleFab() {
            fabMain.classList.toggle('open');
            fabOptions.classList.toggle('show');
        }

        function saveInitialName() {
            const input = document.getElementById('user-nickname');
            const error = document.getElementById('error-txt');
            const name = input.value.trim();

            if (name === "") {
                error.style.display = "block";
                input.style.borderColor = "#e74c3c";
                return;
            }

            localStorage.setItem('staffName', name);
            document.getElementById('name-overlay').classList.remove('show');
            logActivity("Registered Name");
        }

        function switchTab(viewId, hashName) {
            document.querySelectorAll('.view-content').forEach(view => view.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            history.replaceState(null, null, "#" + hashName);
            localStorage.setItem('lastTab', hashName);
            fixIframeScroll();
            if(fabOptions.classList.contains('show')) toggleFab();
            
            logActivity(`Switch to: ${hashName}`);
        }

        function fixIframeScroll() {
            const frames = ['yield-frame', 'tri-frame'];
            frames.forEach(id => {
                const f = document.getElementById(id);
                if (f) {
                    f.style.height = '100%';
                    try { f.contentWindow.document.body.style.overflow = 'hidden'; } catch(e) {}
                }
            });
        }

        function checkInitialTab() {
            if (!localStorage.getItem('staffName')) {
                document.getElementById('name-overlay').classList.add('show');
            }

            const hash = window.location.hash.replace('#', '');
            const lastTab = localStorage.getItem('lastTab');
            const target = hash || lastTab || 'yield';
            switchTab(target === 'tri' ? 'tri-view' : 'yield-view', target);
        }

async function logActivity(extraDetail = "") {
    const _p1 = "https://docs.google.com/forms/d/e/";
    const _p2 = "1FAIpQLScw642uWS3K2B1VQ1JWhWQRwFIUDxqqDaBwYorSIqB8_YpSbg";
    const _p3 = "/formResponse";
    const FORM_URL = _p1 + _p2 + _p3;

    const f = {
        name: atob("ZW50cnkuMTczNjY0MzA0OA=="), // entry.1736643048
        plat: atob("ZW50cnkuMzIxMzQxNzUx"),   // entry.321341751
        ip:   atob("ZW50cnkuOTA3OTM4NjQz"),   // entry.907938643
        beh:  atob("ZW50cnkuMTQ0MjM2MDQyNw==")  // entry.1442360427
    };

    const staffName = localStorage.getItem('staffName');
    if (!staffName || staffName.trim() === "") return; 

    const ua = navigator.userAgent;
    const dev = /Android|iPhone|iPad/i.test(ua) ? "Mobile" : "PC";
    
    let browser = "Unknown";
    if (ua.includes("Line/")) { browser = "LINE"; }
    else if (ua.includes("FBAN") || ua.includes("FBAV")) { browser = "Facebook"; }
    else if (navigator.brave && typeof navigator.brave.isBrave === "function") { browser = "Brave"; }
    else if (ua.includes("DuckDuckGo/")) { browser = "DuckDuckGo"; }
    else if (ua.includes("TorBrowser") || ua.includes("Tor/")) { browser = "Tor"; }
    else if (ua.includes("Edg/")) { browser = "Edge"; }
    else if (ua.includes("OPR/") || ua.includes("Opera")) { browser = "Opera"; }
    else if (ua.includes("Firefox/") || ua.includes("FxiOS/")) { browser = "Firefox"; }
    else if (ua.includes("Chrome") || ua.includes("CriOS")) { browser = "Chrome"; }
    else if (ua.includes("Safari") && !ua.includes("Chrome")) { browser = "Safari"; }

    const platformInfo = `[${dev}/${browser}]`;

    const sendToGoogle = (ipData) => {
        const finalUrl = `${FORM_URL}?` + 
            `${f.name}=${encodeURIComponent(staffName)}&` + 
            `${f.plat}=${encodeURIComponent(platformInfo)}&` +
            `${f.ip}=${encodeURIComponent(ipData)}&` +
            `${f.beh}=${encodeURIComponent(extraDetail || 'Access')}&` +
            `submit=Submit`;
            
        new Image().src = finalUrl;
    };

    try {
        const response = await fetch('https://www.cloudflare.com/cdn-cgi/trace');
        const text = await response.text();
        const ipLine = text.split('\n').find(line => line.startsWith('ip='));
        const ipAddress = ipLine ? ipLine.split('=')[1] : "Unknown IP";
        sendToGoogle(ipAddress);
    } catch (error) {
        sendToGoogle("Direct Access");
    }
}
        window.addEventListener('load', checkInitialTab);
        window.addEventListener('resize', fixIframeScroll);
    </script>
</body>
</html>
