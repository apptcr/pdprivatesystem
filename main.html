<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRODUCTION TOOLS</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #34495e;
            --accent: #3498db;
            --white: #ffffff;
            --shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Prompt', sans-serif; }
        body { background: #f1f5f9; height: 100vh; overflow: hidden; width: 100vw; }
        .view-container { width: 100%; height: 100vh; position: relative; overflow: hidden; }
        .view-content {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: none; overflow: hidden !important;
        }
        .view-content.active { display: block !important; }
        iframe { width: 100%; height: 100%; border: none; display: block; overflow: hidden !important; }

        /* Floating System */
        .fab-wrapper {
            position: fixed; bottom: 20px; right: 20px;
            display: flex; flex-direction: column-reverse; align-items: center; gap: 10px; z-index: 9999;
        }
        .fab-main {
            width: 45px; height: 45px; border-radius: 50%; background: var(--primary);
            color: white; display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; cursor: pointer; box-shadow: var(--shadow);
            transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); border: 2px solid var(--white);
        }
        .fab-main.open { transform: rotate(135deg); background: #e74c3c; }
        .fab-options {
            display: flex; flex-direction: column; gap: 10px;
            opacity: 0; visibility: hidden; transform: translateY(15px); transition: 0.2s;
        }
        .fab-options.show { opacity: 1; visibility: visible; transform: translateY(0); }
        .fab-btn {
            width: 40px; height: 40px; border-radius: 50%; border: none;
            background: var(--white); color: var(--primary); cursor: pointer;
            box-shadow: var(--shadow); display: flex; align-items: center; justify-content: center;
            font-size: 1rem; transition: 0.2s; position: relative;
        }
        .fab-btn:hover { background: var(--accent); color: white; }
    </style>
</head>
<body>

    <div class="view-container">
        <div id="yield-view" class="view-content">
            <iframe id="yield-frame" src="yieldcal.html" scrolling="no"></iframe>
        </div>
        <div id="tri-view" class="view-content">
            <iframe id="tri-frame" src="ruleofthree.html" scrolling="no"></iframe>
        </div>
    </div>

    <div class="fab-wrapper">
        <button class="fab-main" id="fabMain" onclick="toggleFab()">
            <i class="fas fa-th-large"></i>
        </button>
        <div class="fab-options" id="fabOptions">
            <button class="fab-btn" data-label="Rule of Three" onclick="switchTab('tri-view', 'tri')">
                <i class="fas fa-calculator"></i>
            </button>
            <button class="fab-btn" data-label="Yield Calculator" onclick="switchTab('yield-view', 'yield')">
                <i class="fas fa-chart-line"></i>
            </button>
        </div>
    </div>

    <script>
        const fabMain = document.getElementById('fabMain');
        const fabOptions = document.getElementById('fabOptions');

        function toggleFab() {
            fabMain.classList.toggle('open');
            fabOptions.classList.toggle('show');
        }

        function switchTab(viewId, hashName, isInitial = false) {
            document.querySelectorAll('.view-content').forEach(view => view.classList.remove('active'));
            const targetView = document.getElementById(viewId);
            if (targetView) targetView.classList.add('active');
            
            history.replaceState(null, null, "#" + hashName);
            localStorage.setItem('lastTab', hashName);
            
            fixIframeScroll();
            if(!isInitial && fabOptions.classList.contains('show')) toggleFab();

            logActivity(isInitial ? `Access: ${hashName}` : `Switch to: ${hashName}`);
        }

        function fixIframeScroll() {
            const frames = ['yield-frame', 'tri-frame'];
            frames.forEach(id => {
                const f = document.getElementById(id);
                if (f) {
                    f.style.height = '100%';
                    try { f.contentWindow.document.body.style.overflow = 'hidden'; } catch(e) {}
                }
            });
        }

        async function logActivity(behavior = "") {
            const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLScw642uWS3K2B1VQ1JWhWQRwFIUDxqqDaBwYorSIqB8_YpSbg/formResponse";
            
            // --- แก้ไขเลข Entry ID ตรงนี้ให้ครบทั้ง 4 ช่องนะคะ ---
            const ENTRY_ID = "entry.1736643048";       // ช่อง ID เครื่อง
            const ENTRY_PLATFORM = "entry.321341751"; // ** แก้เป็นเลขช่อง Platform **
            const ENTRY_IP = "entry.907938643";       // ** แก้เป็นเลขช่อง IP/Location **
            const ENTRY_BEHAVIOR = "entry.1442360427"; // ช่องพฤติกรรม

            try {
                // 1. Visitor ID
                let visitorId = localStorage.getItem('visitorId');
                if (!visitorId) {
                    visitorId = 'ID-' + Math.random().toString(36).substr(2, 7).toUpperCase();
                    localStorage.setItem('visitorId', visitorId);
                }

                // 2. ข้อมูลพิกัด
                const response = await fetch('https://ipapi.co/json/');
                const data = await response.json();
                const ipInfo = `${data.ip} (${data.city}, ${data.org})`;

                // 3. ข้อมูลอุปกรณ์
                const ua = navigator.userAgent;
                const device = /Android/i.test(ua) ? "Android" : (/iPhone|iPad/i.test(ua) ? "iOS" : "PC");
                const browser = ua.includes("Line/") ? "LINE" : (ua.includes("Chrome") ? "Chrome" : "Safari");
                const platform = `[${device}/${browser}]`;

                // 4. สร้าง URL สำหรับส่งข้อมูลแบบ Image Beacon (วิธีที่ชัวร์ที่สุด)
                const finalUrl = `${FORM_URL}?` + 
                    `${ENTRY_ID}=${encodeURIComponent(visitorId)}&` +
                    `${ENTRY_PLATFORM}=${encodeURIComponent(platform)}&` +
                    `${ENTRY_IP}=${encodeURIComponent(ipInfo)}&` +
                    `${ENTRY_BEHAVIOR}=${encodeURIComponent(behavior)}&` +
                    `submit=Submit`;

                // ส่งผ่านการโหลดรูปภาพ
                const img = new Image();
                img.src = finalUrl;

                console.log("Analytics Sent Successfully");
            } catch (error) {
                console.log("Analytics error:", error);
            }
        }

        window.onload = () => {
            const hash = window.location.hash.replace('#', '');
            const lastTab = localStorage.getItem('lastTab');
            const target = hash || lastTab || 'yield';
            switchTab(target === 'tri' ? 'tri-view' : 'yield-view', target, true);
        };

        window.addEventListener('resize', fixIframeScroll);
    </script>
</body>
</html>
