<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YIELD FAST CALCULATOR</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --primary: #5865F2;
      --text: #212529;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Prompt', 'Kanit', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f6fa;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      overflow: hidden;
      width: 100%;
      max-width: 950px;
    }
    .app-header {
      background: var(--primary);
      color: #fff;
      text-align: center;
      padding: 30px 20px;
    }
    .app-title {
      font-size: 2.2rem;
      font-weight: 700;
      margin-bottom: 8px;
      letter-spacing: 0.5px;
    }
    .app-subtitle {
      font-size: 1rem;
      opacity: 0.95;
      font-weight: 400;
    }
    .content {
      padding: 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }
    thead tr {
      background: var(--primary);
    }
    th {
      color: white;
      padding: 18px 15px;
      font-weight: 600;
      text-align: center;
      font-size: 1.05rem;
    }
    tbody tr {
      border-bottom: 1px solid #f0f0f0;
    }
    td {
      text-align: center;
      padding: 12px 15px;
    }
    td input {
      width: 100%;
      padding: 14px 16px;
      text-align: center;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      background: #fff;
      font-size: 1.05rem;
      transition: all 0.2s ease;
      font-weight: 500;
    }
    td input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(88,101,242,0.1);
    }
    .input-wrapper { 
      position: relative; 
      display: flex; 
      justify-content: center; 
      align-items: center;
    }
    .dropdown-toggle {
      position: absolute;
      right: 12px;
      background: none;
      border: none;
      color: #6c757d;
      cursor: pointer;
      display: none;
      font-size: 16px;
      padding: 5px;
    }
    .dropdown-toggle:hover { color: var(--primary); }
    .dropdown-box {
      position: fixed;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      padding: 15px 18px;
      display: none;
      z-index: 1000;
      min-width: 260px;
      text-align: left;
      border: 1px solid #e0e0e0;
    }
    .dropdown-section { margin-bottom: 12px; }
    .dropdown-title {
      font-weight: 600;
      color: var(--primary);
      font-size: 0.95rem;
      margin-bottom: 6px;
      border-bottom: 1px solid #e0e0e0;
      padding-bottom: 5px;
    }
    .dropdown-item {
      padding: 4px 0;
      font-size: 0.9rem;
      color: #495057;
    }
    .final-result {
      font-weight: 700;
      font-size: 1.05rem;
      border-top: 1px solid #e0e0e0;
      padding-top: 8px;
      margin-top: 8px;
      color: #111;
    }
    .calculated-cell {
      font-size: 1.05rem;
      font-weight: 600;
      padding: 12px;
    }
    .button-group {
      display: flex;
      justify-content: center;
      gap: 12px;
      padding: 25px;
      background: #fff;
    }
    button {
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .btn-add { 
      background: var(--primary); 
      color: white; 
    }
    .btn-add:hover { 
      background: #4752C4; 
    }
    .btn-reset { 
      background: #6c757d; 
      color: white; 
    }
    .btn-reset:hover { 
      background: #5a6268;
    }
    .btn-howto { 
      background: #495057; 
      color: white; 
    }
    .btn-howto:hover { 
      background: #343a40;
    }
    .footer { 
      text-align: center; 
      padding: 15px; 
      font-size: 0.85rem; 
      color: #6c757d; 
      background: #fff;
    }
    @media (max-width: 768px) {
      .app-title { font-size: 1.6rem; }
      .app-subtitle { font-size: 0.9rem; }
      th { font-size: 0.9rem; padding: 12px 8px; }
      td input { font-size: 0.95rem; padding: 10px; }
      .button-group { flex-wrap: wrap; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="app-header">
      <h1 class="app-title">YIELD CALCULATOR</h1>
      <p class="app-subtitle">คำนวณผลผลิตจากรายงานการผลิตอย่างง่าย และรวดเร็ว</p>
    </div>
    <div class="content">
      <table id="calculatorTable">
        <thead><tr><th>ผลิตได้ (kg)</th><th>วัตถุดิบ (kg)</th><th>ส่วนต่าง</th><th>เปอร์เซ็นต์</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="button-group">
        <button class="btn-add" onclick="addRow()"><i class='fas fa-plus'></i> เพิ่มแถว</button>
        <button class="btn-reset" onclick="resetTable()"><i class='fas fa-sync-alt'></i> รีเซต</button>
        <button class="btn-howto" onclick="window.open('yieldhowto.html')"><i class='fas fa-book'></i> คู่มือการใช้งาน</button>
      </div>
      <div class="footer">© 2025 YIELD FAST CALCULATOR by NAMJIT</div>
    </div>
  </div>
  <div id="dropdownBox" class="dropdown-box"></div>

  <script>
    const table=document.querySelector("#calculatorTable tbody");
    const dropdown=document.getElementById("dropdownBox");
    const inputRefs=[];

    function normalizeNumericLiterals(expr){
      expr=expr.trim();
      expr=expr.replace(/^[+\-*/]+/,'');
      const tokens=expr.replace(/\s+/g,'').match(/\d*\.?\d+|[+\-*/()]/g);
      if(!tokens)return expr;
      return tokens.map(t=>(/^\d*\.?\d+$/.test(t)?String(Number(t)):t)).join('');
    }

    function isInvalidExpression(expr){
      if(/(\+\+|--|\*\*|\/\/|\+\*|\*\+|\+\/|\/\+|\-\*|\*\-|\-\/|\/\-)/.test(expr)) return true;
      if(/[+\-*/]$/.test(expr)) return true;
      if(expr.trim()==='') return true;
      return false;
    }

    function parseGroupedSteps(expr){
      const tokens=expr.match(/\d+(?:\.\d+)?|[+\-*/]/g)||[];
      const multiplyDivide=[],addSubtract=[];
      if(tokens.length<3)return {multiplyDivide,addSubtract};
      const calc=(a,o,b)=>o==='*'?a*b:o==='/'?a/b:o==='+'?a+b:a-b;
      let t=[...tokens],i=1;
      while(i<t.length){
        if(['*','/'].includes(t[i])){
          const r=calc(parseFloat(t[i-1]),t[i],parseFloat(t[i+1]));
          multiplyDivide.push(`${t[i-1]} ${t[i]==='*'?'×':'÷'} ${t[i+1]} = ${r.toFixed(2)}`);
          t.splice(i-1,3,r);i=1;continue;
        } i+=2;
      }
      i=1;
      while(i<t.length){
        if(['+','-'].includes(t[i])){
          const r=calc(parseFloat(t[i-1]),t[i],parseFloat(t[i+1]));
          addSubtract.push(`${parseFloat(t[i-1]).toFixed(2)} ${t[i]} ${parseFloat(t[i+1]).toFixed(2)} = ${r.toFixed(2)}`);
          t.splice(i-1,3,r);i=1;continue;
        } i+=2;
      }
      return {multiplyDivide,addSubtract};
    }

    function showDropdown(input,expr,result,grouped){
      const rect=input.getBoundingClientRect();
      dropdown.style.top=rect.bottom+5+'px';
      dropdown.style.left=rect.left+'px';
      dropdown.innerHTML='';
      if(grouped.multiplyDivide.length){
        dropdown.innerHTML+=`<div class='dropdown-section'><div class='dropdown-title'>การคูณ / หาร</div>${grouped.multiplyDivide.map(x=>`<div class='dropdown-item'>${x}</div>`).join('')}</div>`;
      }
      if(grouped.addSubtract.length){
        dropdown.innerHTML+=`<div class='dropdown-section'><div class='dropdown-title'>การบวก / ลบ</div>${grouped.addSubtract.map(x=>`<div class='dropdown-item'>${x}</div>`).join('')}</div>`;
      }
      dropdown.innerHTML+=`<div class='final-result'>ผลลัพธ์สุดท้าย = ${result.toFixed(2)}</div>`;
      dropdown.innerHTML+=`<div style="margin-top:10px;border-top:1px solid #eee;padding-top:6px;text-align:center;">
        <button class='edit-btn' style="background:#f1f1f1;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:0.9rem;">
        <i class='fas fa-edit'></i> แก้ไขสูตรนี้</button></div>`;
      dropdown.style.display='block';

      const editBtn=dropdown.querySelector('.edit-btn');
      editBtn.addEventListener('click',()=>{
        dropdown.style.display='none';
        input.value=input.dataset.expr||'';
        input.focus();
        input.select();
      });
    }

    document.addEventListener('click',()=>dropdown.style.display='none');
    window.addEventListener('scroll',()=>dropdown.style.display='none');
    window.addEventListener('resize',()=>dropdown.style.display='none');

    function createInputCell(onEnter){
      const cell=document.createElement('td');
      const wrap=document.createElement('div');
      wrap.className='input-wrapper';
      const input=document.createElement('input');
      const btn=document.createElement('button');
      btn.className='dropdown-toggle';
      btn.innerHTML="<i class='fas fa-calculator'></i>";
      wrap.append(input,btn);cell.appendChild(wrap);

      btn.addEventListener('click',(e)=>{
        e.stopPropagation();
        const expr=input.dataset.expr;
        const result=parseFloat(input.dataset.result);
        const grouped=JSON.parse(input.dataset.grouped||'{}');
        showDropdown(input,expr,result,grouped);
      });

      input.addEventListener('keydown',e=>{
        if(e.key==='Enter'){
          dropdown.style.display='none';
          let expr=input.value.trim();
          if(expr===''){input.value='';btn.style.display='none';onEnter();return;}
          expr=normalizeNumericLiterals(expr);
          if(isInvalidExpression(expr)){
            input.value='ERROR';
            btn.style.display='none';
            dropdown.style.display='none';
            return;
          }
          try{
            const result=eval(expr);
            if(!isFinite(result)){input.value='ไม่สามารถคำนวณได้';btn.style.display='none';return;}
            const grouped=parseGroupedSteps(expr);
            input.value=parseFloat(result).toFixed(2);
            input.dataset.expr=expr;
            input.dataset.result=result;
            input.dataset.grouped=JSON.stringify(grouped);
            btn.style.display=(/[+\-*/]/.test(expr))?'block':'none';
            onEnter();
          }catch{
            input.value='ERROR';
            btn.style.display='none';
            dropdown.style.display='none';
          }
        }
      });

      input.addEventListener('input',()=>{
        dropdown.style.display='none';
        btn.style.display=/[+\-*/]/.test(input.value)?'block':'none';
      });

      return {cell,input};
    }

    function addRow(){
      const row=document.createElement('tr');
      let i=inputRefs.length;
      const {cell:prod,input:prodInput}=createInputCell(()=>{updateValues();inputRefs[i][1].focus();});
      const {cell:mat,input:matInput}=createInputCell(()=>{updateValues();if(inputRefs[i+1])inputRefs[i+1][0].focus();else{addRow();inputRefs[i+1][0].focus();}});
      const gap=document.createElement('td'),perc=document.createElement('td');
      gap.className='calculated-cell';perc.className='calculated-cell';
      row.append(prod,mat,gap,perc);table.appendChild(row);
      inputRefs.push([prodInput,matInput]);
      function updateValues(){
        const p=parseFloat(prodInput.value),m=parseFloat(matInput.value);
        if(!isNaN(p)&&!isNaN(m)){
          const g=m-p;const per=(p/m)*100;
          gap.textContent=g.toFixed(2)+' kg.';perc.textContent=per.toFixed(2)+'%';
          perc.style.color=per>=90?'#4caf50':per>=80?'#ff9800':'#f44336';
        }else{gap.textContent='';perc.textContent='';}
      }
    }

    function resetTable(){table.innerHTML='';inputRefs.length=0;for(let i=0;i<10;i++)addRow();inputRefs[0][0].focus();}
    for(let i=0;i<10;i++)addRow();
    inputRefs[0][0].focus();
  </script>
</body>
</html>
