<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ö‡∏±‡∏ç‡∏ç‡∏±‡∏ï‡∏¥‡πÑ‡∏ï‡∏£‡∏¢‡∏≤‡∏á‡∏Ñ‡πå | Rule of Three</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-soft: #eef2ff;
            --secondary: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --warning-soft: #fff7ed;
            --warning-border: #fb923c;
            --bg: #f1f5f9;
            --card-bg: #ffffff;
            --text-main: #1e293b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Prompt', sans-serif; }
        
        body { 
            background-color: var(--bg); 
            height: 100vh; 
            overflow: hidden; 
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }

        .app-container {
            width: 100%;
            max-width: 1100px;
            height: 98vh;
            display: flex;
            flex-direction: column;
            gap: 12px;
            position: relative;
        }

        header { display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        h1 { font-size: 20px; color: var(--primary); font-weight: 600; }
        .subtitle { font-size: 12px; color: var(--secondary); font-weight: 300; }

        .top-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; flex-shrink: 0; }
        
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            min-height: 0;
            gap: 10px;
        }

        .card-header-flex { display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .card-title { font-size: 14px; font-weight: 600; color: var(--secondary); display: flex; align-items: center; gap: 5px; }

        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .field label { display: block; font-size: 11px; color: var(--secondary); margin-bottom: 2px; }
        input[type="time"], input[type="text"] {
            width: 100%; padding: 6px 10px; border: 1.5px solid #e2e8f0; border-radius: 8px; font-size: 14px; outline: none;
        }

        .summary-box { 
            display: flex; 
            justify-content: space-around; 
            background: var(--primary-soft); 
            border-radius: 10px; 
            padding: 15px 10px; 
            height: 100%; 
            align-items: center; 
        }
        .stat { text-align: center; }
        .stat-val { display: block; font-size: 18px; font-weight: 600; color: var(--primary); }
        .stat-label { font-size: 10px; color: var(--secondary); text-transform: uppercase; margin-bottom: 2px; display: block; }

        .table-area { flex-grow: 1; min-height: 0; }
        .table-wrapper { 
            height: 100%; 
            overflow-y: auto; 
            border-radius: 8px; 
            border: 1px solid #e2e8f0; 
            scrollbar-gutter: stable;
        }
        
        .table-wrapper::-webkit-scrollbar { width: 6px; }
        .table-wrapper::-webkit-scrollbar-track { background: transparent; }
        .table-wrapper::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        table { width: 100%; border-collapse: collapse; font-size: 14px; table-layout: fixed; }
        th { 
            position: sticky; top: 0; background: #f8fafc; padding: 10px; 
            border-bottom: 2px solid #e2e8f0; z-index: 10; color: var(--secondary);
            font-size: 12px;
        }
        td { padding: 4px 8px; border-bottom: 1px solid #f1f5f9; text-align: center; height: 47.46px; }

        .row-idx { font-weight: 600; color: var(--secondary); width: 50px; }
        .weight-input { text-align: center; background: #f8fafc; width: 100%; border: 1px solid transparent; border-radius: 6px; padding: 4px; }
        .weight-input:focus { background: #fff; border-color: var(--primary); outline: none; }
        
        .time-badge { 
            display: inline-block; 
            width: 85%; 
            padding: 4px 0; 
            border-radius: 6px; 
            font-weight: 600; 
            font-size: 14px; 
            position: relative;
            cursor: help;
            border: 2px solid transparent;
            transition: 0.2s;
        }
        .badge-start { background: #f0fdf4; color: #166534; }
        .badge-end { background: #eff6ff; color: #1e40af; }

        .time-badge.is-break-affected {
            background-color: var(--warning-soft) !important;
            border-color: var(--warning-border) !important;
            color: #c2410c !important;
        }

        .time-badge:hover::after {
            content: attr(data-tooltip);
            position: absolute; bottom: 125%; left: 50%; transform: translateX(-50%);
            background: #1e293b; color: white; padding: 6px 12px; border-radius: 8px;
            font-size: 12px; white-space: nowrap; z-index: 100;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.2); pointer-events: none;
            opacity: 0; animation: fadeIn 0.2s forwards;
        }
        .time-badge[data-tooltip=""]::after { display: none; }

        .bottom-section { flex-shrink: 0; height: 90px; margin-bottom: 20px; }
        .timeline-bar { display: flex; height: 35px; background: #e2e8f0; border-radius: 8px; overflow: hidden; margin-top: 5px; }
        .timeline-segment { height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-size: 11px; font-weight: 600; transition: 0.3s; }

        .btn-add {
            background: var(--primary); color: white; border: none;
            width: 32px; height: 32px; border-radius: 8px; cursor: pointer;
            font-size: 20px; display: flex; align-items: center; justify-content: center;
        }
        .btn-reset { 
            background: #fff1f2; color: var(--danger); border: 1px solid var(--danger); 
            padding: 5px 15px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;
        }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.4); backdrop-filter: blur(4px);
            display: none; align-items: center; justify-content: center; z-index: 1000;
        }
        .modal-content {
            background: white; padding: 25px; border-radius: 16px; width: 90%; max-width: 380px;
            text-align: center; transform: translateY(-20px); animation: slideDown 0.3s forwards;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideDown { to { transform: translateY(0); } }

        .btn { padding: 8px 20px; border-radius: 8px; border: none; font-size: 14px; font-weight: 600; cursor: pointer; }
        .btn-cancel { background: #f1f5f9; color: var(--secondary); }
        .btn-confirm { background: var(--danger); color: white; }

        #copyright-notice {
            position: absolute; bottom: -5px; width: 100%; text-align: center;
            font-size: 10px; color: var(--secondary); opacity: 0.7;
        }
    </style>
</head>
<body>

<div id="confirmModal" class="modal-overlay">
    <div class="modal-content">
        <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤?</div>
        <div style="font-size: 14px; color: var(--secondary); margin-bottom: 20px;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏£‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö</div>
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button class="btn btn-cancel" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button class="btn btn-confirm" onclick="confirmReset()">‡∏ï‡∏Å‡∏•‡∏á ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤</button>
        </div>
    </div>
</div>

<div class="app-container">
    <header>
        <h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ö‡∏±‡∏ç‡∏ç‡∏±‡∏ï‡∏¥‡πÑ‡∏ï‡∏£‡∏¢‡∏≤‡∏á‡∏Ñ‡πå <span class="subtitle">| Rule of Three</span></h1>
        <button class="btn-reset" onclick="openModal()">‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤</button>
    </header>

    <div class="top-row">
        <div class="card">
            <div class="card-title">üïí ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</div>
            <div class="input-grid">
                <div class="field"><label>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</label><input type="time" id="startTime" value="08:00"></div>
                <div class="field"><label>‡∏à‡∏ö‡∏á‡∏≤‡∏ô</label><input type="time" id="endTime" value="17:00"></div>
                <div class="field"><label>‡∏û‡∏±‡∏Å (‡πÄ‡∏£‡∏¥‡πà‡∏°)</label><input type="time" id="breakStart" value="12:00"></div>
                <div class="field"><label>‡∏û‡∏±‡∏Å (‡∏à‡∏ö)</label><input type="time" id="breakEnd" value="13:00"></div>
            </div>
        </div>
        <div class="card">
            <div class="card-title">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ß‡∏°</div>
            <div class="summary-box">
                <div class="stat"><span class="stat-label">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á</span><span id="totalTime" class="stat-val">0:00</span></div>
                <div class="stat"><span class="stat-label">‡∏ô‡∏≤‡∏ó‡∏µ‡∏£‡∏ß‡∏°</span><span id="totalMinutes" class="stat-val">0</span></div>
                <div class="stat"><span class="stat-label">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏°</span><span class="stat-val"><span id="totalWeight">0</span> <small>‡∏Å‡∏Å.</small></span></div>
            </div>
        </div>
    </div>

    <div class="card table-area">
        <div class="card-header-flex">
            <div class="card-title">üìù ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤</div>
            <button id="addRowBtn" class="btn-add">+</button>
        </div>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr><th style="width: 60px;">#</th><th>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.)</th><th>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ú‡∏•‡∏¥‡∏ï</th><th>‡πÄ‡∏™‡∏£‡πá‡∏à</th></tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <div class="card bottom-section">
        <div class="card-title">üéûÔ∏è ‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏•‡∏ô‡πå‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï</div>
        <div id="timeline" class="timeline-bar"></div>
    </div>
    <div id="copyright-notice"></div>
</div>

<script>
    const INITIAL_ROWS = 10;
    let currentTotalItems = INITIAL_ROWS;
    const colors = ['#6366f1', '#8b5cf6', '#d946ef', '#f43f5e', '#f97316', '#eab308', '#22c55e', '#06b6d4', '#3b82f6', '#475569'];

    // License System
    (function() {
        const _0x4f2a = "wqkgMjAyNSBSdWxlIG9mIFRocmVlIGJ5IE5BTUpJVA==";
        try {
            const decoded = decodeURIComponent(escape(atob(_0x4f2a))); 
            document.addEventListener('DOMContentLoaded', () => {
                const footer = document.getElementById('copyright-notice');
                if (footer) footer.innerText = decoded;
            });
        } catch (e) {}
    })();

    document.addEventListener('DOMContentLoaded', () => {
        initTable();
        ['startTime', 'endTime', 'breakStart', 'breakEnd'].forEach(id => {
            document.getElementById(id).addEventListener('input', calculate);
        });
        document.getElementById('addRowBtn').addEventListener('click', addNewRow);
    });

    function openModal() { 
        // ‡∏ô‡∏≥ Focus ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Enter ‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô
        if (document.activeElement) document.activeElement.blur();
        document.getElementById('confirmModal').style.display = 'flex'; 
        window.addEventListener('keydown', handleModalKeys); 
    }

    function closeModal() { 
        document.getElementById('confirmModal').style.display = 'none'; 
        window.removeEventListener('keydown', handleModalKeys); 
    }

    function handleModalKeys(e) { 
        if(e.key === 'Enter') {
            e.preventDefault(); // ‡∏´‡∏¢‡∏∏‡∏î Default Action ‡∏Ç‡∏≠‡∏á Enter
            confirmReset(); 
        } else if(e.key === 'Escape') {
            closeModal(); 
        } 
    }

    function confirmReset() {
        document.getElementById('startTime').value = '08:00'; 
        document.getElementById('endTime').value = '17:00';
        document.getElementById('breakStart').value = '12:00'; 
        document.getElementById('breakEnd').value = '13:00';
        initTable(); 
        closeModal(); 
    }

    function initTable() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = ''; currentTotalItems = INITIAL_ROWS;
        for (let i = 1; i <= INITIAL_ROWS; i++) createRow(i);
        calculate();
    }

    function createRow(index) {
        const tbody = document.getElementById('tableBody');
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="row-idx">${index}</td>
            <td><input type="text" class="weight-input" id="weight-${index}" placeholder="0.0" oninput="handleInput(this)" onkeypress="handleEnter(event, ${index})"></td>
            <td><span id="start-${index}" class="time-badge badge-start" data-tooltip="">-</span></td>
            <td><span id="end-${index}" class="time-badge badge-end" data-tooltip="">-</span></td>
        `;
        tbody.appendChild(row);
    }

    function addNewRow() {
        currentTotalItems++; createRow(currentTotalItems);
        const wrapper = document.querySelector('.table-wrapper');
        wrapper.scrollTop = wrapper.scrollHeight;
        document.getElementById(`weight-${currentTotalItems}`).focus();
        calculate();
    }

    let timer;
    function handleInput(input) {
        clearTimeout(timer);
        timer = setTimeout(() => {
            try {
                if(input.value && isNaN(input.value)) {
                    const v = new Function('return ' + input.value)();
                    if(!isNaN(v) && v >= 0) input.value = v.toFixed(1);
                }
            } catch(e){}
            calculate();
        }, 400);
    }

    function handleEnter(e, i) {
        if(e.key === 'Enter') {
            const next = document.getElementById(`weight-${i+1}`);
            if(next) next.focus(); else addNewRow();
        }
    }

    function timeToMin(t) { const [h, m] = t.split(':').map(Number); return h * 60 + m; }
    function minToTime(m) {
        const total = Math.floor(m);
        const h = Math.floor(total / 60) % 24;
        const min = total % 60;
        return `${h.toString().padStart(2,'0')}:${min.toString().padStart(2,'0')}`;
    }

    function formatDuration(minutes) {
        if (minutes <= 0) return "0 ‡∏ô‡∏≤‡∏ó‡∏µ";
        const h = Math.floor(minutes / 60);
        const m = Math.round(minutes % 60);
        let res = "";
        if (h > 0) res += `${h} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á `;
        if (m > 0 || h === 0) res += `${m} ‡∏ô‡∏≤‡∏ó‡∏µ`;
        return res.trim();
    }

    function calculate() {
        let start = timeToMin(document.getElementById('startTime').value);
        let end = timeToMin(document.getElementById('endTime').value);
        if(end < start) end += 1440;
        let bStart = timeToMin(document.getElementById('breakStart').value);
        let bEnd = timeToMin(document.getElementById('breakEnd').value);
        if(bEnd < bStart) bEnd += 1440;

        let workSlots = [];
        if (bStart >= end || bEnd <= start) { workSlots.push({s: start, e: end}); } 
        else {
            if (start < bStart) workSlots.push({s: start, e: Math.min(end, bStart)});
            if (end > bEnd) workSlots.push({s: Math.max(start, bEnd), e: end});
        }

        let totalMinutes = workSlots.reduce((sum, slot) => sum + (slot.e - slot.s), 0);
        document.getElementById('totalTime').innerText = `${Math.floor(totalMinutes/60)}:${(totalMinutes%60).toString().padStart(2,'0')}`;
        document.getElementById('totalMinutes').innerText = totalMinutes;

        let weights = []; let totalWeight = 0;
        for(let i=1; i<=currentTotalItems; i++) {
            let el = document.getElementById(`weight-${i}`);
            let v = el ? parseFloat(el.value) || 0 : 0;
            weights.push({id: i, val: v}); totalWeight += v;
        }
        document.getElementById('totalWeight').innerText = totalWeight.toLocaleString();

        const timeline = document.getElementById('timeline');
        timeline.innerHTML = '';

        if(totalMinutes <= 0 || totalWeight <= 0) {
            document.querySelectorAll('.time-badge').forEach(b => { b.innerText = "-"; b.classList.remove('is-break-affected'); b.setAttribute('data-tooltip', ''); });
            return;
        }

        let currentSlot = 0; let currentTime = workSlots[0].s;
        
        weights.forEach((item, idx) => {
            const sEl = document.getElementById(`start-${item.id}`);
            const eEl = document.getElementById(`end-${item.id}`);
            if(!sEl) return;

            if(item.val === 0) {
                sEl.innerText = "-"; eEl.innerText = "-";
                sEl.classList.remove('is-break-affected'); eEl.classList.remove('is-break-affected');
                sEl.setAttribute('data-tooltip', ''); eEl.setAttribute('data-tooltip', '');
                return;
            }

            let need = (item.val / totalWeight) * totalMinutes;
            let actualStart = currentTime;
            let breakTaken = 0;

            let remainingNeed = need;
            while (remainingNeed > 0.000001 && currentSlot < workSlots.length) {
                let slotEnd = workSlots[currentSlot].e;
                let avail = slotEnd - currentTime;
                if (avail >= remainingNeed) {
                    currentTime += remainingNeed;
                    remainingNeed = 0;
                } else {
                    remainingNeed -= avail;
                    currentSlot++;
                    if (currentSlot < workSlots.length) {
                        breakTaken += (workSlots[currentSlot].s - slotEnd);
                        currentTime = workSlots[currentSlot].s;
                    } else {
                        currentTime = slotEnd;
                    }
                }
            }

            let actualEnd = currentTime;
            const displayStartStr = minToTime(actualStart);
            const displayEndStr = minToTime(actualEnd);
            const displayStartTotal = Math.floor(actualStart);
            const displayEndTotal = Math.floor(actualEnd);
            const diffMin = displayEndTotal - displayStartTotal - breakTaken;
            
            let tooltip = `‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ú‡∏•‡∏¥‡∏ï ${formatDuration(Math.max(0, diffMin))}`;
            
            if(breakTaken > 0) {
                tooltip += ` (‡∏£‡∏ß‡∏°‡∏û‡∏±‡∏Å‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á ${formatDuration(breakTaken)})`;
                sEl.classList.add('is-break-affected');
                eEl.classList.add('is-break-affected');
                sEl.innerText = " " + displayStartStr;
                eEl.innerText = " " + displayEndStr;
            } else {
                sEl.classList.remove('is-break-affected');
                eEl.classList.remove('is-break-affected');
                sEl.innerText = displayStartStr;
                eEl.innerText = displayEndStr;
            }

            sEl.setAttribute('data-tooltip', tooltip);
            eEl.setAttribute('data-tooltip', tooltip);

            let bar = document.createElement('div');
            bar.className = 'timeline-segment';
            bar.style.width = (item.val / totalWeight * 100) + '%';
            bar.style.backgroundColor = colors[idx % colors.length];
            bar.innerText = item.id;
            timeline.appendChild(bar);
        });
    }
</script>

</body>
</html>
